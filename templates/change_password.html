{% extends "layout.html" %}
{% block title %}Change Password{% endblock %}

{% block content %}
<div class="bg-white shadow rounded p-6">
  <h2 class="text-xl font-semibold mb-4">Change Password</h2>
  <form id="passwordForm" class="space-y-4">
    <div>
      <label class="block text-sm font-medium text-gray-700">Current password</label>
      <input id="currentPassword" type="password" class="mt-1 block w-full" required />
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">New password</label>
      <input id="newPassword" type="password" class="mt-1 block w-full" required />
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Confirm new password</label>
      <input id="confirmNewPassword" type="password" class="mt-1 block w-full" required />
    </div>
    <div>
      <button type="submit" class="bg-blue-700 text-white px-4 py-2 rounded">Change Password</button>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const token = localStorage.getItem('access_token');
  if (!token) { window.location.href = '/login'; return; }

  document.getElementById('passwordForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    const original = btn.innerHTML;
    btn.disabled = true;
    btn.textContent = 'Updating...';

    const payload = {
      current_password: document.getElementById('currentPassword').value,
      new_password: document.getElementById('newPassword').value,
      confirm_new_password: document.getElementById('confirmNewPassword').value
    };

    try {
      const resp = await fetch('/auth/password', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        if (resp.status === 401) { localStorage.clear(); window.location.href = '/login'; return; }
        const err = await resp.json().catch(()=>({detail:'Unknown error'}));
        throw new Error(err.detail || 'Failed to change password');
      }

      showToast('Password changed successfully', 'success');
      // Clear sensitive fields
      document.getElementById('currentPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmNewPassword').value = '';
      setTimeout(()=> window.location.href = '/dashboard', 800);
    } catch (err) {
      showToast(err.message || 'Error changing password', 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = original;
    }
  });
});
</script>
{% endblock %}
